# JWT Authentication Implementation Guide

## Overview
This document describes the complete JWT-based authentication system implemented for the Blood Bank Management System, including all security features and configurations.

## Features Implemented

### 1. JWT-Based Authentication
- **Token Generation**: Access tokens and refresh tokens are generated using JWT
- **Token Validation**: Automatic validation of JWT tokens on each request
- **Token Expiration**: Configurable token expiration times
- **Refresh Token Mechanism**: Secure token refresh without re-authentication

### 2. Password Security
- **BCrypt Encryption**: All passwords are encrypted using BCrypt with default strength
- **Secure Storage**: Passwords are never stored in plain text
- **Password Validation**: Minimum 6 characters required

### 3. Role-Based Authorization
- **User Roles**: ADMIN, USER, DONOR, RECIPIENT
- **Endpoint Protection**: Different endpoints protected by different roles
- **Method-Level Security**: `@PreAuthorize` annotations for fine-grained control

### 4. Account Security
- **Login Attempt Limiting**: Maximum 5 failed attempts before account lock
- **Account Locking**: Automatic account locking after failed attempts
- **Account Unlocking**: Admin can unlock accounts manually
- **Failed Attempt Tracking**: Database tracking of failed login attempts

### 5. CORS Configuration
- **Cross-Origin Support**: Configured to allow cross-origin requests
- **Flexible Headers**: All headers allowed
- **Multiple Methods**: GET, POST, PUT, DELETE, OPTIONS supported

### 6. CSRF Protection
- **CSRF Disabled**: Disabled for API endpoints (stateless JWT authentication)
- **Stateless Sessions**: No server-side session storage

### 7. Security Logging
- **Unauthorized Access Logging**: All unauthorized access attempts are logged
- **Authentication Events**: Login success/failure events logged
- **Account Locking Events**: Account locking events logged

## Configuration

### JWT Configuration (application.properties)
```properties
# JWT Configuration
jwt.secret=bloodSyncSecretKeyForJWTTokenGenerationAndValidation2024
jwt.expiration=3600000
jwt.refresh.expiration=86400000
```

### Security Configuration
- **Session Management**: Stateless sessions
- **CORS**: Enabled with flexible configuration
- **CSRF**: Disabled for API endpoints
- **Authentication**: JWT-based with refresh tokens

## API Endpoints

### Public Endpoints (No Authentication Required)
- `POST /api/auth/register` - User registration
- `POST /api/auth/login` - User login
- `POST /api/auth/refresh` - Token refresh
- `GET /api/auth/health` - Health check

### Role-Based Protected Endpoints
- `/api/admin/**` - ADMIN role required
- `/api/hospital/**` - HOSPITAL role required
- `/api/donor/**` - DONOR role required
- `/api/request/**` - RECIPIENT or PATIENT role required

### General Protected Endpoints
- `/api/**` - Any authenticated user

## Usage Examples

### 1. User Registration
```bash
curl -X POST http://localhost:8080/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "newuser",
    "email": "user@example.com",
    "password": "password123",
    "fullName": "New User",
    "role": "USER"
  }'
```

**Response:**
```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiJ9...",
  "refreshToken": "eyJhbGciOiJIUzI1NiJ9...",
  "tokenType": "Bearer",
  "username": "newuser",
  "role": "USER"
}
```

### 2. User Login
```bash
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "newuser",
    "password": "password123"
  }'
```

### 3. Accessing Protected Endpoints
```bash
curl -X GET http://localhost:8080/api/hospitals \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiJ9..."
```

### 4. Token Refresh
```bash
curl -X POST http://localhost:8080/api/auth/refresh \
  -H "Content-Type: application/json" \
  -d '{
    "refreshToken": "eyJhbGciOiJIUzI1NiJ9..."
  }'
```

## Security Features Details

### 1. JWT Token Structure
- **Header**: Algorithm (HS256)
- **Payload**: Subject (username), issued at, expiration
- **Signature**: HMAC SHA256 signature

### 2. Account Locking Mechanism
- **Failed Attempts**: Tracked in database
- **Lock Threshold**: 5 failed attempts
- **Lock Duration**: Until manually unlocked by admin
- **Reset on Success**: Failed attempts reset on successful login

### 3. Password Security
- **BCrypt Strength**: Default (10 rounds)
- **Salt**: Automatically generated by BCrypt
- **Validation**: Minimum 6 characters required

### 4. Role-Based Access Control
- **Role Hierarchy**: ADMIN > USER > DONOR/RECIPIENT
- **Endpoint Protection**: URL-based and method-based protection
- **Dynamic Authorization**: Runtime role checking

## Error Handling

### Authentication Errors
- **401 Unauthorized**: Invalid credentials or expired token
- **403 Forbidden**: Insufficient permissions
- **423 Locked**: Account locked due to failed attempts

### Validation Errors
- **400 Bad Request**: Invalid input data
- **409 Conflict**: Username/email already exists

### Server Errors
- **500 Internal Server Error**: Unexpected server errors

## Security Best Practices Implemented

1. **Token Expiration**: Short-lived access tokens (1 hour)
2. **Refresh Tokens**: Long-lived refresh tokens (24 hours)
3. **Secure Headers**: JWT tokens in Authorization header
4. **Password Hashing**: BCrypt with salt
5. **Input Validation**: Comprehensive validation on all inputs
6. **Error Logging**: Security events logged for monitoring
7. **CORS Configuration**: Proper CORS setup for web clients
8. **Stateless Design**: No server-side session storage

## Monitoring and Logging

### Security Events Logged
- Failed login attempts
- Account locking events
- Unauthorized access attempts
- Token validation failures
- User registration events

### Log Levels
- **INFO**: Successful operations
- **WARN**: Security warnings (failed attempts, locked accounts)
- **ERROR**: System errors and exceptions

## Testing the Implementation

### 1. Test Registration
```bash
# Register a new user
curl -X POST http://localhost:8080/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","email":"test@example.com","password":"password123","fullName":"Test User","role":"USER"}'
```

### 2. Test Login
```bash
# Login with the registered user
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","password":"password123"}'
```

### 3. Test Protected Endpoint
```bash
# Use the access token to access protected endpoints
curl -X GET http://localhost:8080/api/hospitals \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

### 4. Test Account Locking
```bash
# Try multiple failed logins to test account locking
for i in {1..6}; do
  curl -X POST http://localhost:8080/api/auth/login \
    -H "Content-Type: application/json" \
    -d '{"username":"testuser","password":"wrongpassword"}'
done
```

## Database Schema Updates

The User entity has been enhanced with security-related fields:

```sql
ALTER TABLE users ADD COLUMN account_non_locked BOOLEAN DEFAULT TRUE;
ALTER TABLE users ADD COLUMN failed_attempts INT DEFAULT 0;
ALTER TABLE users ADD COLUMN lock_time DATETIME;
ALTER TABLE users ADD COLUMN refresh_token TEXT;
ALTER TABLE users ADD COLUMN refresh_token_expiry DATETIME;
ALTER TABLE users ADD COLUMN created_at DATETIME;
ALTER TABLE users ADD COLUMN updated_at DATETIME;
```

## Conclusion

This JWT authentication implementation provides a comprehensive security solution for the Blood Bank Management System with:

- Secure token-based authentication
- Role-based access control
- Account security features
- Comprehensive logging
- Proper error handling
- CORS support for web clients

The system is production-ready and follows security best practices for JWT-based authentication in Spring Boot applications. 